<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><?= appName ?> · v<?= version ?></title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="<?= include_('style') ?>" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div id="app" class="app">
    <div class="gradient-bg"></div>

    <!-- FIRST-RUN ADMIN SETUP -->
    <div id="setupView" class="card auth-card hidden">
      <div class="brand"><h1>Initialize Admin</h1><p>First-time setup — create your ADMIN account</p></div>
      <div class="field"><label>Name</label><input id="setupName" placeholder="Admin name"></div>
      <div class="field"><label>Email</label><input id="setupEmail" type="email" placeholder="admin@office.gov"></div>
      <div class="field"><label>Password</label><input id="setupPass" type="password" placeholder="Strong password"></div>
      <button class="btn primary" id="btnSetupAdmin">Create Admin</button>
      <div id="setupMsg" class="msg"></div>
    </div>

    <!-- AUTH -->
    <div id="authView" class="card auth-card hidden">
      <div class="brand"><h1><?= appName ?></h1><p>Modern, stylish, cloud-based file manager</p></div>
      <div class="tabs"><button id="tabLogin" class="tab active">Login</button><button id="tabSignup" class="tab">Sign up</button></div>
      <div id="loginPane">
        <div class="field"><label>Email</label><input id="loginEmail" type="email" placeholder="you@office.gov" /></div>
        <div class="field"><label>Password</label><input id="loginPass" type="password" placeholder="••••••••" /></div>
        <button class="btn primary" id="btnLogin">Login</button>
      </div>
      <div id="signupPane" class="hidden">
        <div class="field"><label>Name</label><input id="suName" type="text" placeholder="Your name" /></div>
        <div class="field"><label>Email</label><input id="suEmail" type="email" placeholder="you@office.gov" /></div>
        <div class="field"><label>Password</label><input id="suPass" type="password" placeholder="Create password" /></div>
        <button class="btn" id="btnSignup">Request Approval</button>
      </div>
      <div id="authMsg" class="msg"></div>
    </div>

    <!-- DASHBOARD (private) -->
    <div id="dashView" class="hidden">
      <header class="topbar">
        <div class="left"><h2>Dashboard</h2><div class="badge" id="currentUser"></div></div>
        <div class="right">
          <button id="btnExport" class="btn small">Export</button>
          <button id="btnAdmin" class="btn small">Admin Panel</button>
          <button id="btnLogout" class="btn small warn">Logout</button>
        </div>
      </header>

      <section class="toolbar">
        <div class="group">
          <button id="btnCreateFile" class="btn primary">Create File</button>
          <button id="btnAddLetter" class="btn">Add Letter</button>
          <button id="btnCopyMove" class="btn">Copy/Move</button>
        </div>
        <div class="group">
          <div class="search"><input id="searchBox" placeholder="Search files, sub-files, letters..." /><div id="suggestions" class="suggestions"></div></div>
          <select id="filterType">
            <option value="ALL">All Types</option>
            <option>Pink File</option><option>Brown File</option>
            <option>White Backing</option><option>Register</option><option>Custom</option>
          </select>
        </div>
      </section>

      <section id="fileExplorer" class="explorer"></section>
    </div>

    <!-- PUBLIC READ-ONLY VIEW (no login) -->
    <div id="publicView" class="card auth-card hidden" style="max-width:760px;">
      <div class="brand"><h1>File Snapshot (Read-only)</h1><p>This public page shows basic details only.</p></div>
      <div id="pubBody"></div>
      <div class="sub" style="margin-top:6px;">Want more? <a href="#" id="gotoLogin">Login</a> for full tools.</div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminView" class="drawer hidden">
      <div class="drawer-head"><h3>Admin Panel</h3><button id="adminClose" class="icon-btn">&times;</button></div>
      <div class="drawer-body">
        <div class="admin-grid">
          <div class="admin-card"><h4>Users & Approvals</h4><div id="usersList"></div></div>
          <div class="admin-card">
            <h4>Inventory Designer</h4><p class="sub">Define almirahs; numbers generate dropdowns automatically.</p>
            <div id="invRows"></div>
            <button id="invAdd" class="btn small">Add Almirah</button>
            <button id="invSave" class="btn small primary">Save Inventory</button>
          </div>
          <div class="admin-card"><h4>Permissions quick-sets</h4><ul id="permLegend"></ul></div>
        </div>
      </div>
    </div>

    <!-- MODAL -->
    <div id="modal" class="modal hidden">
      <div class="modal-card">
        <div class="modal-head"><h4 id="modalTitle">Modal</h4><button id="modalClose" class="icon-btn">&times;</button></div>
        <div id="modalBody" class="modal-body"></div>
        <div class="modal-foot"><button id="modalOk" class="btn primary">OK</button></div>
      </div>
    </div>
  </div>

  <script>
    let BOOT=null, TOKEN=null, USER=null, PUBLIC_INV=[];

    function $(q){ return document.querySelector(q); }
    function el(t,c,h){ const n=document.createElement(t); if(c) n.className=c; if(h!==undefined) n.innerHTML=h; return n; }
    function show(q, yes){ const n=$(q); if(!n) return; n.classList.toggle('hidden',!yes); }
    function msg(node, text, kind='info'){ node.textContent=text; node.className='msg '+kind; }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }
    function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
    function downloadBase64(b64, name, mime){ const a=document.createElement('a'); a.href='data:'+mime+';base64,'+b64; a.download=name; a.click(); }

    // Bootstrap
    google.script.run.withSuccessHandler(boot=>{
      BOOT=boot;
      // Route sniffer early (for public view)
      const url=new URL(location.href);
      const route=url.searchParams.get('v');
      if (route==='public'){ showPublic(url.searchParams.get('id')); return; }
      if (boot.needSetup){ show('#setupView', true); bindSetup(); }
      else initAuth();
    }).api_bootstrap();

    // ---------- Public read-only flow ----------
    function showPublic(id){
      show('#publicView', true);
      show('#authView', false); show('#dashView', false); show('#setupView', false);
      $('#gotoLogin').onclick=()=>{ location.href = location.origin + location.pathname; };
      const host=$('#pubBody'); host.innerHTML='Loading...';
      google.script.run.withSuccessHandler(res=>{
        if (!res.ok){ host.innerHTML='<div class="msg error">Not found or unavailable.</div>'; return; }
        const f=res.file, subs=res.subfiles||[];
        const panel=el('div','file-detail',`
          <h3>${escapeHtml(f.FileNo||'')} — ${escapeHtml(f.Name||'')}</h3>
          <p>${escapeHtml(f.Description||'')}</p>
          <div class="chips">
            <span class="tag">${escapeHtml(f.Type||'')}</span>
            <span class="tag">${escapeHtml(f.Status||'')}</span>
            <span class="tag">Pages: ${f.Pages||0}</span>
          </div>
          <div class="sub">Location: Almirah ${f.LocationAlmirah||'-'}, Rack ${f.LocationRack||'-'}, Row ${f.LocationRow||'-'}, Column ${f.LocationColumn||'-'}</div>
          <h4 style="margin-top:10px;">Sub-files (${subs.length})</h4>
        `);
        subs.forEach(s=> panel.appendChild(el('div','sub-item',`<b>${escapeHtml(s.Name||'')}</b> <span class="dim">(${escapeHtml(s.Type||'')})</span> — ${s.Pages||0} pages`)));
        host.innerHTML=''; host.appendChild(panel);
      }).api_file_public(id);
    }

    // ---------- First-run admin setup ----------
    function bindSetup(){
      $('#btnSetupAdmin').onclick=()=>{
        const name=$('#setupName').value.trim(), email=$('#setupEmail').value.trim(), pass=$('#setupPass').value;
        google.script.run.withSuccessHandler(res=>{
          if (res.ok){ TOKEN=res.token; USER=res.user; localStorage.setItem('TH_FMS_TOKEN',TOKEN); enterApp(); }
          else msg($('#setupMsg'), res.msg||'Setup failed', 'error');
        }).api_setup_admin(name,email,pass);
      };
    }

    // ---------- Auth ----------
    function initAuth(){
      const saved=localStorage.getItem('TH_FMS_TOKEN');
      if (saved){
        google.script.run.withSuccessHandler(res=>{
          if(res.ok){ TOKEN=saved; USER=res.user; enterApp(); } else showAuth();
        }).api_currentUser(saved);
      } else showAuth();
    }
    function showAuth(){ show('#authView', true); bindAuth(); }
    function bindAuth(){
      $('#tabLogin').onclick=()=>{ $('#loginPane').classList.remove('hidden'); $('#signupPane').classList.add('hidden'); $('#tabLogin').classList.add('active'); $('#tabSignup').classList.remove('active'); };
      $('#tabSignup').onclick=()=>{ $('#signupPane').classList.remove('hidden'); $('#loginPane').classList.add('hidden'); $('#tabSignup').classList.add('active'); $('#tabLogin').classList.remove('active'); };
      $('#btnLogin').onclick=()=>{
        const email=$('#loginEmail').value.trim(), pass=$('#loginPass').value;
        google.script.run.withSuccessHandler(res=>{
          if(res.ok){ TOKEN=res.token; USER=res.user; localStorage.setItem('TH_FMS_TOKEN',TOKEN); enterApp(); }
          else msg($('#authMsg'), res.msg||'Login failed', 'error');
        }).api_login(email, pass);
      };
      $('#btnSignup').onclick=()=>{
        const name=$('#suName').value.trim(), email=$('#suEmail').value.trim(), pass=$('#suPass').value;
        google.script.run.withSuccessHandler(res=>{
          msg($('#authMsg'), res.msg, res.ok?'success':'error');
        }).api_signup(email, name, pass);
      };
    }

    // ---------- App (private) ----------
    function enterApp(){
      show('#publicView', false); show('#setupView', false); show('#authView', false); show('#dashView', true);
      $('#currentUser').innerText = USER.name+' · '+USER.role;
      bindDash();
      preloadInventoryAndExplorer();
    }
    function bindDash(){
      $('#btnAdmin').onclick=()=>openAdmin();
      $('#btnCreateFile').onclick=()=> openCreateFile();
      $('#btnAddLetter').onclick=()=> openAddLetter();
      $('#btnCopyMove').onclick=()=> openCopyMove();
      $('#btnExport').onclick=()=> openExport();
      $('#btnLogout').onclick=()=>{ localStorage.removeItem('TH_FMS_TOKEN'); location.reload(); };
      $('#filterType').onchange=()=> loadExplorer();
      $('#searchBox').addEventListener('input', onSearchInput);
    }

    // Inventory for dropdowns
    function preloadInventoryAndExplorer(){
      google.script.run.withSuccessHandler(inv=>{ PUBLIC_INV=inv||[]; loadExplorer(); }).api_inventory_listPublic(TOKEN);
    }

    // Search
    let tipTimer=null;
    function onSearchInput(){
      clearTimeout(tipTimer);
      const t=$('#searchBox').value.trim(); const type=$('#filterType').value;
      tipTimer=setTimeout(()=>{
        google.script.run.withSuccessHandler(res=>{
          const box=$('#suggestions'); box.innerHTML='';
          (res.suggestions||[]).forEach(s=>{ const it=el('div','suggestion',s); it.onclick=()=>{ $('#searchBox').value=s; box.innerHTML=''; loadExplorer(); }; box.appendChild(it); });
        }).api_search(TOKEN,{text:t, type});
        loadExplorer();
      },200);
    }

    // Explorer (private)
    function loadExplorer(){
      const type=$('#filterType').value; const text=$('#searchBox').value.trim();
      google.script.run.withSuccessHandler(files=>{
        const host=$('#fileExplorer'); host.innerHTML='';
        files.forEach(f=>{
          const card=el('div','file-card type-'+(f.Type||'Custom').replace(/\s+/g,''));
          card.appendChild(el('div','file-head',
            `<div class="file-tags">
              <span class="tag">${f.Type}</span>
              <span class="tag ${f.Status==='Archived'?'arch':''}">${f.Status}</span>
            </div>
            <h4>${f.FileNo} — ${escapeHtml(f.Name||'')}</h4>
            <div class="sub">Almirah ${f.LocationAlmirah || '-'} · Rack ${f.LocationRack || '-'} · Row ${f.LocationRow || '-'} · Col ${f.LocationColumn || '-'}</div>
            <div class="sub">Last action by: ${f.LastActionBy||f.UpdatedBy||'-'}</div>`));
          const actions=el('div','actions');
          const btnEdit=el('button','btn small','Edit'); btnEdit.onclick=()=> openEditFile(f);
          const btnDel=el('button','btn small warn','Delete'); btnDel.onclick=()=> deleteFile(f);
          const btnQR=el('button','btn small','QR'); btnQR.onclick=()=> openQRModal(f); // now public QR
          actions.append(btnEdit, btnDel, btnQR);
          card.appendChild(actions);
          const exp=el('details','subs'); exp.appendChild(el('summary','',`Sub-files (${f.subfiles.length})`));
          const list=el('div','sub-list'); (f.subfiles||[]).forEach(s=> list.appendChild(el('div','sub-item',`<b>${escapeHtml(s.Name||'')}</b> <span class="dim">(${s.Type})</span> — ${s.Pages||0} pages`)));
          exp.appendChild(list); card.appendChild(exp); host.appendChild(card);
        });
      }).api_files_list(TOKEN,{text, type});
    }

    // Picker helpers
    function lettersFromCount(n){ const out=[]; for(let i=0;i<n;i++) out.push(String.fromCharCode(65+i)); return out; }
    function selectHTML(id, opts){ const o=['<option value="">-</option>'].concat((opts||[]).map(v=>`<option value="${v}">${v}</option>`)).join(''); return `<select id="${id}">${o}</select>`; }

    function locPickersHTML(){
      const alm=(PUBLIC_INV||[]).map(i=>i.almirah);
      return `
        <div class="grid">
          <div><label>Almirah</label>${selectHTML('fAlm', alm)}</div>
          <div><label>Rack</label>${selectHTML('fRack', [])}</div>
          <div><label>Row</label>${selectHTML('fRow', [])}</div>
          <div><label>Column</label>${selectHTML('fCol', [])}</div>
        </div>
        <p class="sub">Pickers auto-fill from Inventory to avoid typos.</p>`;
    }
    function bindLocationPickers(initial){
      const almSel=$('#fAlm'), rackSel=$('#fRack'), rowSel=$('#fRow'), colSel=$('#fCol');
      function fill(){ 
        const a=almSel.value; const rec=(PUBLIC_INV||[]).find(x=>x.almirah===a);
        const racks = rec? Array.from({length:rec.racks},(_,i)=>i+1) : [];
        const rows  = rec? Array.from({length:rec.rows},(_,i)=>String.fromCharCode(65+i)) : [];
        const cols  = rec? Array.from({length:rec.columns},(_,i)=>i+1) : [];
        rackSel.innerHTML=['<option value="">-</option>'].concat(racks.map(x=>`<option>${x}</option>`)).join('');
        rowSel.innerHTML=['<option value="">-</option>'].concat(rows.map(x=>`<option>${x}</option>`)).join('');
        colSel.innerHTML=['<option value="">-</option>'].concat(cols.map(x=>`<option>${x}</option>`)).join('');
        if (initial){ if (initial.LocationRack) rackSel.value=initial.LocationRack; if (initial.LocationRow) rowSel.value=initial.LocationRow; if (initial.LocationColumn) colSel.value=initial.LocationColumn; }
      }
      almSel.onchange=fill; fill();
      if (initial && initial.LocationAlmirah){ almSel.value=initial.LocationAlmirah; fill(); }
    }

    // Modal
    function openModal(title, bodyHTML, okHandler){
      $('#modalTitle').innerText=title; $('#modalBody').innerHTML=bodyHTML; show('#modal', true);
      const ok=$('#modalOk'); ok.onclick=null; ok.onclick=()=>{ if (okHandler) okHandler(); };
      $('#modalClose').onclick=()=> show('#modal', false);
    }

    // Create / Edit
    function typeOptionsHTML(){ return ['Pink File','Brown File','White Backing','Register','Custom'].map(t=>`<option>${t}</option>`).join(''); }
    function openCreateFile(){
      openModal('Create File', `
        <div class="grid"><div><label>File No. (unique)</label><input id="fNo" /></div><div><label>Name</label><input id="fName" /></div></div>
        <div class="grid"><div><label>Type</label><select id="fType">${typeOptionsHTML()}</select></div><div><label>Status</label><select id="fStatus"><option>Active</option><option>Inactive</option><option>Archived</option></select></div></div>
        <label>Description</label><textarea id="fDesc"></textarea>
        ${locPickersHTML()}
        <div class="grid"><div><label>Pages</label><input id="fPages" type="number" min="0" value="0"/></div><div><label>Attachments</label><input id="fAttach" type="file" multiple/></div></div>
      `, async ()=>{
        const files=$('#fAttach').files; const attIds=[];
        for (let i=0;i<files.length;i++){ const b=await fileToBase64(files[i]); const up=await new Promise(res=>google.script.run.withSuccessHandler(res).api_upload_attachment(TOKEN, b.split(',').pop(), files[i].name, files[i].type)); if (up.ok) attIds.push(up.fileId); }
        google.script.run.withSuccessHandler(r=>{ if(!r.ok) alert(r.msg||'Error'); show('#modal', false); loadExplorer(); }).api_file_create(TOKEN,{
          fileNo:$('#fNo').value.trim(), name:$('#fName').value.trim(), description:$('#fDesc').value.trim(), type:$('#fType').value, status:$('#fStatus').value,
          locAlmirah:$('#fAlm').value, locRack:$('#fRack').value, locRow:$('#fRow').value, locColumn:$('#fCol').value, pages:+($('#fPages').value||0), attachmentIds:attIds
        });
      });
      bindLocationPickers();
    }
    function openEditFile(f){
      openModal('Edit File', `
        <label>Name</label><input id="efName" value="${escapeHtml(f.Name||'')}" />
        <label>Description</label><textarea id="efDesc">${escapeHtml(f.Description||'')}</textarea>
        <div class="grid"><div><label>Type</label><select id="efType">${typeOptionsHTML()}</select></div><div><label>Status</label><select id="efStatus"><option>Active</option><option>Inactive</option><option>Archived</option></select></div></div>
        ${locPickersHTML()}
        <div class="grid"><div><label>Pages</label><input id="efPages" type="number" min="0" value="${f.Pages||0}"/></div></div>
      `, ()=>{
        google.script.run.withSuccessHandler(r=>{ if(!r.ok) alert(r.msg||'Update failed'); show('#modal', false); loadExplorer(); }).api_file_update(TOKEN, f.Id, {
          Name:$('#efName').value.trim(), Description:$('#efDesc').value.trim(), Type:$('#efType').value, Status:$('#efStatus').value,
          LocationAlmirah:$('#fAlm').value, LocationRack:$('#fRack').value, LocationRow:$('#fRow').value, LocationColumn:$('#fCol').value,
          Pages:+($('#efPages').value||0), LastActionBy: USER.email
        });
      });
      $('#efType').value=f.Type; $('#efStatus').value=f.Status;
      bindLocationPickers({LocationAlmirah:f.LocationAlmirah,LocationRack:f.LocationRack,LocationRow:f.LocationRow,LocationColumn:f.LocationColumn});
    }
    function deleteFile(f){ if (!confirm('Delete this file?')) return; google.script.run.withSuccessHandler(()=>loadExplorer()).api_file_delete(TOKEN,f.Id); }

    // Letters
    function openAddLetter(){
      openModal('Add Letter', `
        <div class="grid"><div><label>File ID</label><input id="ltFileId" placeholder="Target File Id"/></div><div><label>Sub-File ID (optional)</label><input id="ltSubId"/></div></div>
        <label>Title</label><input id="ltTitle"/><label>Description</label><textarea id="ltDesc"></textarea>
        <div class="grid"><div><label>Pages</label><input id="ltPages" type="number" min="0" value="1"/></div><div><label>Attachment</label><input id="ltAttach" type="file" multiple/></div></div>
      `, async ()=>{
        const files=$('#ltAttach').files; const attIds=[];
        for (let i=0;i<files.length;i++){ const b=await fileToBase64(files[i]); const up=await new Promise(res=>google.script.run.withSuccessHandler(res).api_upload_attachment(TOKEN, b.split(',').pop(), files[i].name, files[i].type)); if (up.ok) attIds.push(up.fileId); }
        google.script.run.withSuccessHandler(()=>{ show('#modal', false); loadExplorer(); }).api_letter_add(TOKEN,{
          fileId:$('#ltFileId').value.trim(), subFileId:$('#ltSubId').value.trim()||'', title:$('#ltTitle').value.trim(), description:$('#ltDesc').value.trim(), pages:+($('#ltPages').value||0), attachmentIds:attIds
        });
      });
    }

    // Copy/Move
    function openCopyMove(){
      openModal('Copy/Move Sub-File', `
        <div class="grid"><div><label>Sub-File ID</label><input id="cmSid" /></div><div><label>Destination File ID</label><input id="cmDest" /></div></div>
        <label>Action</label><select id="cmAct"><option value="MOVE">Move</option><option value="COPY">Copy</option></select>
      `, ()=>{
        const isCopy=$('#cmAct').value==='COPY';
        google.script.run.withSuccessHandler(()=>{ show('#modal', false); loadExplorer(); }).api_subfile_moveCopy(TOKEN,$('#cmSid').value.trim(),$('#cmDest').value.trim(),isCopy);
      });
    }

    // Export
    function openExport(){
      openModal('Export Data', `
        <div class="grid"><div><label>What</label><select id="exKind"><option value="FILES">Files</option></select></div><div><label>Format</label><select id="exFmt"><option>CSV</option><option>XLSX</option><option>PDF</option></select></div></div>
        <p class="sub">PDFs use safe margins; XLSX generated from a temp Sheet.</p>
      `, ()=>{
        const kind=$('#exKind').value, fmt=$('#exFmt').value;
        google.script.run.withSuccessHandler(res=>{
          if (res.ok){ downloadBase64(res.download.data, res.download.name, res.download.mime); } else alert(res.msg||'Export failed');
          show('#modal', false);
        }).api_export(TOKEN, kind, fmt);
      });
    }

    // QR → now generates PUBLIC link
    function openQRModal(f){
      openModal('Generate QR (Public) for '+f.FileNo, `
        <div id="qrBox" class="qrbox"></div>
        <p class="sub">This QR opens a <b>public, read-only</b> page of this file.</p>
      `, async ()=>{
        const canvas=$('#qrBox').querySelector('canvas');
        const png=canvas.toDataURL('image/png');
        google.script.run.withSuccessHandler(()=> loadExplorer()).api_set_file_qr(TOKEN, f.Id, png);
        show('#modal', false);
      });
      const url = location.origin + location.pathname + '?v=public&id=' + encodeURIComponent(f.Id);
      new QRCode(document.getElementById('qrBox'), { text:url, width:220, height:220 });
    }

    // Admin
    function openAdmin(){
      show('#adminView', true); $('#adminClose').onclick=()=> show('#adminView', false);
      google.script.run.withSuccessHandler(list=>{
        const host=$('#usersList'); host.innerHTML='';
        list.forEach(u=>{
          const row=el('div','user-row');
          row.innerHTML=`<div><b>${u.Name}</b><div class="dim">${u.Email}</div></div>
                         <div><span class="pill ${u.Role==='ADMIN'?'p-admin':'p-manager'}">${u.Role}</span></div>
                         <div><span class="pill ${u.Status!=='ACTIVE'?'p-pending':'p-ok'}">${u.Status}</span></div>`;
          const act=el('div','user-actions');
          const selRole=el('select','',`<option>ADMIN</option><option>MANAGER</option>`); selRole.value=u.Role;
          const selStatus=el('select','',`<option>ACTIVE</option><option>PENDING</option><option>DISABLED</option>`); selStatus.value=u.Status;
          const permInput=el('input','',``); permInput.placeholder='comma perms (optional)';
          const btnSave=el('button','btn small','Save'); btnSave.onclick=()=> {
            const perms=permInput.value.trim()?permInput.value.split(',').map(x=>x.trim()).filter(Boolean):undefined;
            google.script.run.withSuccessHandler(()=> openAdmin()).api_admin_setUser(TOKEN, u.Id, {Role:selRole.value, Status:selStatus.value, Permissions:perms});
          };
          act.append(selRole, selStatus, permInput, btnSave); row.appendChild(act); host.appendChild(row);
        });
      }).api_admin_listUsers(TOKEN);

      google.script.run.withSuccessHandler(inv=>{
        PUBLIC_INV=inv; const host=$('#invRows'); host.innerHTML=''; inv.forEach(addInvRow);
      }).api_inventory_get(TOKEN);
      $('#invAdd').onclick=()=> addInvRow({almirah:'A'+Math.floor(Math.random()*10), racks:5, rows:5, columns:10});
      $('#invSave').onclick=()=>{
        const rows=[...document.querySelectorAll('.inv-row')].map(r=>({almirah:r.querySelector('.i-alm').value, racks:+r.querySelector('.i-rack').value, rows:+r.querySelector('.i-rows').value, columns:+r.querySelector('.i-cols').value}));
        google.script.run.withSuccessHandler(()=>{ alert('Inventory saved'); preloadInventoryAndExplorer(); }).api_inventory_set(TOKEN, rows);
      };

      const legend=['USER_MANAGE','INVENTORY_MANAGE','FILE_CREATE','FILE_EDIT','FILE_DELETE','FILE_MOVE_COPY','LETTER_ADD','EXPORT_DATA','VIEW_AUDIT','APPROVE_USERS'];
      const ul=$('#permLegend'); ul.innerHTML=''; legend.forEach(p=> ul.appendChild(el('li','',p)));
    }
    function addInvRow(x){
      const host=$('#invRows'); const row=el('div','inv-row');
      row.innerHTML=`<input class="i-alm" value="${x.almirah||''}" placeholder="Almirah name"/>
                     <input type="number" class="i-rack" value="${x.racks||1}" min="1" />
                     <input type="number" class="i-rows" value="${x.rows||1}" min="1" />
                     <input type="number" class="i-cols" value="${x.columns||1}" min="1" />`;
      host.appendChild(row);
    }

    // (Optional legacy private route handler kept for backwards compatibility)
    (function legacyPrivateRoute(){
      const url=new URL(location.href); if (url.searchParams.get('v')!=='file') return;
      const id=url.searchParams.get('id'); const saved=localStorage.getItem('TH_FMS_TOKEN');
      if (!saved){ show('#authView', true); msg($('#authMsg'),'Please login to view file','info'); return; }
      TOKEN=saved;
      google.script.run.withSuccessHandler(res=>{ if(res.ok){ USER=res.user; enterApp(); } else showAuth(); }).api_currentUser(saved);
      google.script.run.withSuccessHandler(list=>{
        const f=list.find(x=>x.Id===id); if (!f){ alert('File not found'); return; }
        show('#dashView', true);
        const panel=el('div','file-detail',`
          <h3>${f.FileNo} — ${escapeHtml(f.Name||'')}</h3>
          <p>${escapeHtml(f.Description||'')}</p>
          <div class="chips"><span class="tag">${f.Type}</span><span class="tag">${f.Status}</span><span class="tag">Pages: ${f.Pages||0}</span></div>
          <div class="sub">Location: Almirah ${f.LocationAlmirah||'-'}, Rack ${f.LocationRack||'-'}, Row ${f.LocationRow||'-'}, Column ${f.LocationColumn||'-'}</div>
          <h4>Sub-files (${f.subfiles.length})</h4>
        `);
        f.subfiles.forEach(s=> panel.appendChild(el('div','sub-item',`<b>${escapeHtml(s.Name||'')}</b> <span class="dim">(${s.Type})</span> — ${s.Pages||0} pages`)));
        $('#fileExplorer').innerHTML=''; $('#fileExplorer').appendChild(panel);
      }).api_files_list(TOKEN,{});
    })();
  </script>
</body>
</html>
