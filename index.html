<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Titan FMS | Contract Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
    
    /* Clean Sidebar */
    .sidebar { background: #111827; color: #fff; transition: width 0.3s; }
    .sidebar-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; color: #9ca3af; transition: 0.2s; cursor: pointer; }
    .sidebar-link:hover, .sidebar-link.active { background: #374151; color: #fff; }

    /* Cards */
    .card { background: white; border-radius: 12px; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.2s; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #d1d5db; }

    /* Badges */
    .badge { padding: 4px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    .badge-active { background: #dcfce7; color: #166534; }
    .badge-expired { background: #f3f4f6; color: #4b5563; }
    
    /* File Types */
    .file-pink { border-left: 4px solid #ec4899; }
    .file-brown { border-left: 4px solid #d97706; }

    /* Transitions */
    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
  </style>
</head>
<body>
  <div id="app" class="h-screen flex overflow-hidden">
    
    <div v-if="loading" class="fixed inset-0 bg-white/80 z-50 flex flex-col items-center justify-center">
      <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
      <p class="mt-4 font-semibold text-gray-600">Syncing Titan Database...</p>
    </div>

    <div v-if="page === 'login'" class="fixed inset-0 bg-gray-50 flex items-center justify-center z-40">
      <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-100">
        <div class="text-center mb-8">
           <div class="inline-block p-3 bg-blue-100 rounded-xl text-blue-600 mb-3"><i class="fa-solid fa-layer-group text-2xl"></i></div>
           <h1 class="text-2xl font-bold text-gray-900">Titan FMS</h1>
           <p class="text-gray-500 text-sm">Contract & File Management</p>
        </div>
        <form @submit.prevent="handleLogin" class="space-y-4">
          <input v-model="auth.email" type="text" placeholder="Username/Email" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" required>
          <input v-model="auth.pass" type="password" placeholder="Password" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" required>
          <button class="w-full bg-gray-900 text-white py-3 rounded-xl font-medium hover:bg-black transition">Sign In</button>
        </form>
      </div>
    </div>

    <template v-else>
      <aside class="sidebar w-64 flex-shrink-0 flex flex-col">
        <div class="p-6 border-b border-gray-800">
          <h2 class="text-xl font-bold tracking-tight">TITAN <span class="text-blue-500">PRO</span></h2>
          <div class="text-xs text-gray-500 mt-1">Logged in as {{ user.name }}</div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 space-y-2">
          <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 px-2">Main</div>
          <div @click="navHome" :class="`sidebar-link ${!activeCat ? 'active':''}`"><i class="fa-solid fa-home w-5"></i> Dashboard</div>
          
          <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mt-6 mb-2 px-2">Contract Categories</div>
          <div v-for="cat in db.categories" :key="cat.CategoryID" 
               @click="selectCategory(cat)" 
               :class="`sidebar-link ${activeCat?.CategoryID === cat.CategoryID ? 'active':''}`">
            <i class="fa-solid fa-folder w-5"></i> {{ cat.Name }}
          </div>

          <div v-if="user.role==='Admin'" class="mt-8">
             <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 px-2">System</div>
             <div @click="page='admin'" :class="`sidebar-link ${page==='admin' ? 'active':''}`"><i class="fa-solid fa-cog w-5"></i> Settings</div>
          </div>
        </div>
        <div class="p-4 border-t border-gray-800">
          <button @click="logout" class="w-full py-2 text-sm text-red-400 hover:text-red-300 flex items-center justify-center gap-2"><i class="fa-solid fa-sign-out"></i> Logout</button>
        </div>
      </aside>

      <main class="flex-1 flex flex-col bg-gray-50 overflow-hidden relative">
        <header class="bg-white border-b px-8 py-4 flex justify-between items-center shadow-sm z-10">
          <div class="flex items-center gap-2 text-sm">
             <span @click="navHome" class="text-gray-500 hover:text-blue-600 cursor-pointer">Home</span>
             <span v-if="activeCat" class="text-gray-400">/</span>
             <span v-if="activeCat" @click="selectCategory(activeCat)" class="font-medium cursor-pointer hover:text-blue-600">{{ activeCat.Name }}</span>
             <span v-if="activeContract" class="text-gray-400">/</span>
             <span v-if="activeContract" class="font-bold text-gray-900">{{ activeContract.FirmName }}</span>
          </div>
          
          <div class="flex gap-4">
             <input v-model="search" type="text" placeholder="Search anything..." class="bg-gray-100 border-none rounded-lg px-4 py-2 text-sm w-64 focus:ring-2 focus:ring-blue-500 outline-none">
             <button v-if="canAdd" @click="openCreateModal" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 shadow-lg shadow-blue-200">
               <i class="fa-solid fa-plus mr-1"></i> Add {{ addLabel }}
             </button>
          </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8">
          
          <div v-if="!activeCat && page!=='admin' && !viewFileId" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
             <div v-for="cat in db.categories" @click="selectCategory(cat)" class="card p-6 cursor-pointer group">
                <div class="flex justify-between items-start mb-4">
                   <div class="p-3 bg-blue-50 text-blue-600 rounded-xl group-hover:bg-blue-600 group-hover:text-white transition"><i class="fa-solid fa-folder-tree text-xl"></i></div>
                   <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-md">{{ getContractCount(cat.CategoryID) }} Contracts</span>
                </div>
                <h3 class="font-bold text-lg text-gray-900">{{ cat.Name }}</h3>
                <p class="text-sm text-gray-500 mt-1 line-clamp-2">{{ cat.Description }}</p>
             </div>
             <div v-if="db.categories.length===0" class="col-span-full text-center py-20 text-gray-400">
                <i class="fa-solid fa-box-open text-4xl mb-2"></i><br>No Categories. Create one to start.
             </div>
          </div>

          <div v-if="activeCat && !activeContract && !viewFileId" class="max-w-5xl mx-auto">
             <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
               <i class="fa-solid fa-file-contract text-blue-600"></i> Contracts for {{ activeCat.Name }}
             </h2>
             <div class="space-y-4">
               <div v-for="con in filteredContracts" :key="con.ContractID" @click="selectContract(con)" class="card p-5 cursor-pointer flex items-center justify-between hover:border-blue-400">
                  <div class="flex items-center gap-4">
                     <div :class="`w-2 h-16 rounded-full ${con.Status==='Active'?'bg-green-500':'bg-gray-300'}`"></div>
                     <div>
                        <h3 class="font-bold text-lg text-gray-800">{{ con.FirmName }}</h3>
                        <div class="text-sm text-gray-500 flex gap-4 mt-1">
                           <span><i class="fa-regular fa-calendar mr-1"></i> {{ con.StartDate }} - {{ con.EndDate }}</span>
                           <span><i class="fa-solid fa-hashtag mr-1"></i> {{ con.AgreementNo }}</span>
                        </div>
                     </div>
                  </div>
                  <div class="text-right">
                     <span :class="`badge ${con.Status==='Active'?'badge-active':'badge-expired'}`">{{ con.Status }}</span>
                     <div class="text-xs text-gray-400 mt-2">ID: {{ con.ContractID }}</div>
                  </div>
               </div>
             </div>
          </div>

          <div v-if="activeContract && !viewFileId" class="max-w-6xl mx-auto">
             <div class="bg-white rounded-xl p-6 mb-6 shadow-sm border border-gray-200">
                <div class="flex justify-between">
                   <div>
                      <h1 class="text-2xl font-bold text-gray-900">{{ activeContract.FirmName }}</h1>
                      <div class="text-sm text-gray-500 mt-1">{{ activeContract.Description }}</div>
                   </div>
                   <div class="text-right">
                      <div class="text-sm font-bold text-gray-700">Agreement No: {{ activeContract.AgreementNo }}</div>
                      <div class="text-sm text-gray-500">{{ activeContract.StartDate }} to {{ activeContract.EndDate }}</div>
                   </div>
                </div>
             </div>

             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div v-for="file in filteredFiles" :key="file.FileID" class="card p-0 overflow-hidden">
                   <div :class="`h-2 w-full ${file.Type==='Pink File'?'bg-pink-500':'bg-amber-600'}`"></div>
                   <div class="p-5">
                      <div class="flex justify-between items-start mb-2">
                         <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded">{{ file.FileNo }}</span>
                         <span class="text-xs text-green-600 font-bold" v-if="file.Status==='Active'">Active</span>
                      </div>
                      <h4 class="font-bold text-gray-900 mb-1 cursor-pointer hover:text-blue-600" @click="openFileDetails(file)">{{ file.FileName }}</h4>
                      <div class="text-xs text-gray-500 mb-4">{{ file.Location }} â€¢ {{ file.Pages }} Pages</div>
                      
                      <div class="flex justify-between items-center border-t pt-3">
                         <button @click="openFileDetails(file)" class="text-sm text-blue-600 font-medium hover:underline">Open File</button>
                         <button @click="showQR(file)" class="text-gray-400 hover:text-black"><i class="fa-solid fa-qrcode"></i></button>
                      </div>
                   </div>
                </div>
             </div>
          </div>

          <div v-if="viewFileId && currentFile" class="max-w-4xl mx-auto slide-up">
             <button @click="closeFileView" class="mb-4 text-sm text-gray-500 hover:text-black"><i class="fa-solid fa-arrow-left"></i> Back to Contract</button>
             
             <div class="card p-8 relative">
                <div class="absolute top-0 right-0 p-6">
                   <img :src="`https://chart.googleapis.com/chart?chs=100x100&cht=qr&chl=${encodeURIComponent(currentFile.QrCodeURL)}`" class="border p-1 rounded">
                </div>
                
                <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ currentFile.FileName }}</h1>
                <div class="flex gap-4 text-sm text-gray-500 mb-6">
                   <span><i class="fa-solid fa-hashtag"></i> {{ currentFile.FileNo }}</span>
                   <span><i class="fa-solid fa-location-dot"></i> {{ currentFile.Location }}</span>
                   <span class="px-2 py-0.5 rounded-full bg-gray-100 text-xs border border-gray-300">{{ currentFile.Type }}</span>
                </div>

                <div class="border-t pt-6">
                   <div class="flex justify-between items-center mb-4">
                      <h3 class="font-bold text-lg">Documents / Sub-files</h3>
                      <label class="bg-black text-white px-3 py-1.5 rounded-lg text-sm cursor-pointer hover:bg-gray-800">
                         <i class="fa-solid fa-upload mr-1"></i> Upload
                         <input type="file" hidden @change="uploadDoc">
                      </label>
                   </div>
                   
                   <div class="space-y-2">
                      <div v-for="doc in currentDocs" class="p-3 bg-gray-50 rounded-lg flex justify-between items-center border hover:bg-white transition">
                         <div class="flex items-center gap-3">
                            <i class="fa-regular fa-file-pdf text-red-500 text-lg"></i>
                            <span class="font-medium text-gray-700">{{ doc.Name }}</span>
                         </div>
                         <a :href="doc.Link" target="_blank" class="text-blue-600 text-sm hover:underline">View</a>
                      </div>
                      <div v-if="currentDocs.length===0" class="text-center py-6 text-gray-400 text-sm">No documents inside this file yet.</div>
                   </div>
                </div>
             </div>
          </div>
          
          <div v-if="page==='admin'" class="max-w-4xl mx-auto">
             <h2 class="text-2xl font-bold mb-6">System Settings</h2>
             <div class="card p-6">
               <h3 class="font-bold mb-4">User Management</h3>
               <table class="w-full text-sm text-left">
                 <thead class="bg-gray-50 text-gray-500"><tr><th class="p-3">Name</th><th>Email</th><th>Role</th><th>Status</th></tr></thead>
                 <tbody>
                   <tr v-for="u in adminUsers" :key="u.idx" class="border-b"><td class="p-3">{{u.name}}</td><td>{{u.email}}</td><td>{{u.role}}</td><td>{{u.status}}</td></tr>
                 </tbody>
               </table>
               <div class="mt-4 p-4 bg-yellow-50 text-yellow-800 rounded text-sm">To add users, use the 'Request Access' flow on login or manual DB entry in this version.</div>
             </div>
          </div>

        </div>
      </main>

      <div v-if="modal.show" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
         <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl slide-up">
            <h3 class="text-xl font-bold mb-4">Add {{ addLabel }}</h3>
            <form @submit.prevent="submitCreate" class="space-y-4">
               
               <div v-if="!activeCat">
                  <input v-model="form.name" placeholder="Category Name (e.g. Security)" class="w-full p-3 border rounded-lg" required>
                  <textarea v-model="form.desc" placeholder="Description" class="w-full p-3 border rounded-lg"></textarea>
               </div>

               <div v-else-if="activeCat && !activeContract">
                  <input v-model="form.firmName" placeholder="Firm Name" class="w-full p-3 border rounded-lg" required>
                  <input v-model="form.agreeNo" placeholder="Agreement No" class="w-full p-3 border rounded-lg">
                  <div class="flex gap-2">
                     <div class="flex-1"><label class="text-xs text-gray-500">Start</label><input v-model="form.startDate" type="date" class="w-full p-3 border rounded-lg" required></div>
                     <div class="flex-1"><label class="text-xs text-gray-500">End</label><input v-model="form.endDate" type="date" class="w-full p-3 border rounded-lg" required></div>
                  </div>
                  <textarea v-model="form.desc" placeholder="Notes" class="w-full p-3 border rounded-lg"></textarea>
               </div>

               <div v-else>
                  <div class="flex gap-2">
                     <input v-model="form.fileNo" placeholder="File No" class="flex-1 p-3 border rounded-lg" required>
                     <select v-model="form.type" class="p-3 border rounded-lg"><option>Pink File</option><option>Brown File</option></select>
                  </div>
                  <input v-model="form.name" placeholder="File Name / Subject" class="w-full p-3 border rounded-lg" required>
                  <select v-model="form.location" class="w-full p-3 border rounded-lg"><option value="" disabled selected>Select Location</option><option v-for="l in db.locations" :value="l">{{ l }}</option></select>
                  <input v-model="form.pages" placeholder="Page Count" type="number" class="w-full p-3 border rounded-lg">
               </div>

               <div class="flex justify-end gap-3 pt-4">
                  <button type="button" @click="modal.show=false" class="px-4 py-2 text-gray-500">Cancel</button>
                  <button class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold">Create</button>
               </div>
            </form>
         </div>
      </div>

    </template>
  </div>

  <script>
    const API_URL = "https://fms2.clickworld.workers.dev"; // PASTE WORKER URL HERE WITHOUT TRAILING SLASH

    const { createApp } = Vue;
    createApp({
      data() {
        return {
          loading: false, page: 'login', auth: { email:'', pass:'' }, user: null,
          db: { categories: [], contracts: [], files: [], documents: [], locations: [] },
          activeCat: null, activeContract: null, viewFileId: null, search: '',
          modal: { show: false }, form: {}, adminUsers: []
        }
      },
      computed: {
        addLabel() {
           if(!this.activeCat) return 'Category';
           if(!this.activeCat || !this.activeContract) return 'Contract';
           return 'File';
        },
        canAdd() { return this.user && this.page!=='admin' && !this.viewFileId; },
        filteredContracts() {
           if(!this.activeCat) return [];
           return this.db.contracts.filter(c => c.CategoryID === this.activeCat.CategoryID);
        },
        filteredFiles() {
           if(!this.activeContract) return [];
           return this.db.files.filter(f => f.ContractID === this.activeContract.ContractID);
        },
        currentFile() { return this.db.files.find(f => f.FileID === this.viewFileId); },
        currentDocs() { return this.db.documents.filter(d => d.FileID === this.viewFileId); }
      },
      mounted() {
        // Deep Link Check
        const params = new URLSearchParams(window.location.search);
        if(params.get('view') === 'file' && params.get('id')) {
           localStorage.setItem('pendingView', params.get('id')); // Handle after login
        }
      },
      methods: {
        async api(action, payload={}) {
           this.loading = true;
           try {
             const r = await fetch(API_URL, {method:'POST', body:JSON.stringify({action, payload})});
             const d = await r.json(); this.loading=false; return d;
           } catch(e) { this.loading=false; alert('Error'); return {success:false}; }
        },
        async handleLogin() {
           const res = await this.api('login', this.auth);
           if(res.success) {
              this.user = res.user; this.page = 'app'; await this.refreshDB();
              // Handle Deep Link
              const pending = localStorage.getItem('pendingView');
              if(pending) {
                 this.viewFileId = pending; localStorage.removeItem('pendingView');
                 // Try to resolve breadcrumbs backwards (simplified)
                 const f = this.db.files.find(x => x.FileID == pending);
                 if(f) {
                    this.activeContract = this.db.contracts.find(c => c.ContractID === f.ContractID);
                    if(this.activeContract) this.activeCat = this.db.categories.find(c => c.CategoryID === this.activeContract.CategoryID);
                 }
              }
           } else alert(res.msg);
        },
        async refreshDB() {
           const res = await this.api('getData');
           if(res.success) this.db = res.data;
           if(this.user.role === 'Admin') {
              const uRes = await this.api('getUsers');
              if(uRes.success) this.adminUsers = uRes.data;
           }
        },
        
        // Navigation
        navHome() { this.activeCat=null; this.activeContract=null; this.viewFileId=null; },
        selectCategory(c) { this.activeCat=c; this.activeContract=null; this.viewFileId=null; },
        selectContract(c) { this.activeContract=c; this.viewFileId=null; },
        openFileDetails(f) { this.viewFileId = f.FileID; },
        closeFileView() { this.viewFileId = null; },
        getContractCount(cid) { return this.db.contracts.filter(c => c.CategoryID === cid).length; },
        
        // Creation
        openCreateModal() { this.form = {}; this.modal.show = true; },
        async submitCreate() {
           let action = '', payload = { ...this.form, user: this.user.name };
           
           if(!this.activeCat) { action='createCategory'; }
           else if(!this.activeContract) { 
              action='createContract'; 
              payload.catId = this.activeCat.CategoryID; 
           } else { 
              action='createFile'; 
              payload.contractId = this.activeContract.ContractID; 
              payload.frontendUrl = window.location.origin + window.location.pathname; 
           }

           const res = await this.api(action, payload);
           if(res.success) { this.modal.show=false; this.refreshDB(); }
        },
        async uploadDoc(e) {
           const f = e.target.files[0];
           if(!f) return;
           const reader = new FileReader();
           reader.onload = async (ev) => {
              const res = await this.api('uploadDoc', {
                 fileId: this.viewFileId, name: f.name, mime: f.type, 
                 data: ev.target.result.split(',')[1], user: this.user.name
              });
              if(res.success) this.refreshDB();
           };
           reader.readAsDataURL(f);
        },
        showQR(f) { window.open(f.QrCodeURL, '_blank'); },
        logout() { location.reload(); }
      }
    }).mount('#app');
  </script>
</body>
</html>
